name: Update SOURCE_DATE_EPOCH

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    # Once a day
    - cron: "*/5 * * * *"

jobs:
  update_source_data_epoch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9

      - name: Get current timestamp
        id: timestamp
        run: |
          echo timestamp_sec=$(date +%s) >> $GITHUB_OUTPUT

      - name: Update SOURCE_DATE_EPOCH
        run: |
          echo "${{ steps.timestamp.outputs.timestamp_sec }}" > SOURCE_DATE_EPOCH

      - name: Create PR
        id: pr
        uses: peter-evans/create-pull-request@0cd7ff0e63a08ac27378fc70cf0df976be6bbbfa
        with:
          add-paths: |
            SOURCE_DATE_EPOCH
          commit-message: "Bump SOURCE_DATE_EPOCH version to ${{ steps.timestamp.outputs.timestamp_sec }}"
          title: "Bump SOURCE_DATE_EPOCH version to ${{ steps.timestamp.outputs.timestamp_sec }}"
          body: "SOURCE_DATE_EPOCH is used for reproducible builds."
          delete-branch: true
          author: github_actions

      - name: Enable auto-merge
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{steps.pr.outputs.pull-request-url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
